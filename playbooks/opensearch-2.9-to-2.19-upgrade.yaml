metadata:
  description: "3-node OpenSearch 2.9 to 2.19 minor upgrade test with data validation"

config:
  kubernetes:
    cluster_name: "opensearch-upgrade-2.9-2.19"
    nodes: 3  # 3-node cluster for OpenSearch operator requirements


phases:
  - name: "setup"
    description: "Deploy 3-node cluster with OpenSearch 2.9"
    steps:
      - action: setup_cluster
        params:
          nodes: 3
      - action: install_operator
      - action: deploy_cluster
        params:
          cluster_name: "upgrade-test-cluster"
          version: "2.9.0"
          dashboards:
            enabled: false  # Disable dashboards for faster startup
            replicas: 0
            version: "2.9.0"
          cluster_settings:
            # Set disk watermarks appropriate for test environments with constrained disk space
            "cluster.routing.allocation.disk.watermark.low": "95%"
            "cluster.routing.allocation.disk.watermark.high": "97%"
            "cluster.routing.allocation.disk.watermark.flood_stage": "99%"
          node_pools:
            - component: "nodes"
              roles: ["master", "data", "ingest"]
              replicas: 3
      - action: wait_for_cluster_ready
        params:
          conditions:
            - cluster_health: "yellow"  # Accept yellow initially, validate green separately
            - all_nodes_ready: true
      - action: update_cluster_allocation_settings
        params:
          allocation_enable: "all"

  - name: "validate_cluster"
    description: "Validate cluster is ready and properly configured"
    steps:
      - action: validate_cluster_health
        params:
          expected_status: "green"
          timeout: "15m"  # More time for all nodes to be ready
          check_nodes: true
          check_indices: true
      - action: validate_cluster_configuration
        params:
          total_nodes:
            expected: 3
          node_role_distribution:
            master:
              minimum: 3
              maximum: 3
            data:
              minimum: 3
              maximum: 3

  - name: "create_test_data"
    description: "Create test data in OpenSearch 2.9"
    steps:
      - action: index_documents
        params:
          count: 2000
          index: "test-data-v2.9"
          bulk_size: 100
          replicas: 2  # Use 2 replicas to ensure green status requires all 3 nodes
          shards: 1
          document_template: |
            {
              "id": {id},
              "timestamp": "{timestamp}",
              "version": "2.9",
              "message": "Test document created in OpenSearch 2.9 - {id}",
              "category": "{random:analytics,logs,metrics,events}",
              "level": "{random:INFO,WARN,ERROR,DEBUG}",
              "service": "{random:web,api,db,cache,queue}",
              "value": {id},
              "nested_data": {
                "sub_field": "nested_value_{id}",
                "numeric_field": {id}
              }
            }
      - action: validate_data_integrity
        params:
          indices: ["test-data-v2.9"]
          expected_documents: 2000
          sample_queries:
            - query: '{"match_all": {}}'
              expected_hits: 2000

  - name: "upgrade_to_2.19"
    description: "Upgrade OpenSearch from 2.9 to 2.19"
    steps:
      - action: validate_cluster_health
        params:
          expected_status: "green"
          timeout: "10m"
      - action: upgrade_cluster
        params:
          target_version: "2.19.0"
          strategy: "rolling"
          max_unavailable: 0  # Careful rolling upgrade
          # Validation steps are executed during the rolling upgrade process
          # These steps run between each node upgrade to ensure cluster stability
          # - check_cluster_health: Validates cluster status is green before proceeding
          # - validate_data_integrity: Ensures all indexed data remains accessible and uncorrupted
          validation_steps:
            - "check_cluster_health"
            - "validate_data_integrity"
          rollback_on_failure: true
          timeout: "15m"  # Minor upgrades should be faster than major upgrades
      - action: update_cluster_allocation_settings
        params:
          allocation_enable: "all"
      - action: wait_for_cluster_ready
        params:
          timeout: "5m"
          conditions:
            - cluster_health: "green"
            - all_nodes_ready: true
            - indices_ready: true

  - name: "post_upgrade_validation"
    description: "Validate cluster after upgrade to 2.19"
    steps:
      - action: validate_cluster_version
        params:
          expected_version: "2.19.0"
          timeout: "5m"
      - action: update_cluster_allocation_settings
        params:
          allocation_enable: "all"
      - action: validate_cluster_health
        params:
          expected_status: "green"
          timeout: "10m"
          check_nodes: true
          check_indices: true
      - action: validate_data_integrity
        params:
          indices: ["test-data-v2.9"]
          expected_documents: 2000
          checksum_validation: true
          sample_queries:
            - query: '{"match_all": {}}'
              expected_hits: 2000
            - query: '{"term": {"version": "2.9"}}'
              expected_hits: 2000
      - action: query_documents
        params:
          index: "test-data-v2.9"
          query: '{"bool": {"must": [{"term": {"version": "2.9"}}, {"range": {"value": {"gte": 100, "lte": 200}}}]}}'
          expected_min_count: 50

  - name: "new_data_in_2.19"
    description: "Create new data in OpenSearch 2.19"
    steps:
      - action: update_cluster_allocation_settings
        params:
          allocation_enable: "all"
      - action: index_documents
        params:
          count: 1500
          index: "test-data-v2.19"
          bulk_size: 100
          replicas: 2  # Use 2 replicas to ensure all nodes are working
          shards: 1
          document_template: |
            {
              "id": {id},
              "timestamp": "{timestamp}",
              "version": "2.19",
              "message": "Test document created in OpenSearch 2.19 - {id}",
              "category": "{random:analytics,logs,metrics,events}",
              "level": "{random:INFO,WARN,ERROR,DEBUG}",
              "service": "{random:web,api,db,cache,queue}",
              "value": {id},
              "minor_upgrade": "2.9_to_2.19",
              "compatibility_data": {
                "backward_compatible": true,
                "feature_enhanced": true
              }
            }
      - action: validate_data_integrity
        params:
          indices: ["test-data-v2.19"]
          expected_documents: 1500
          sample_queries:
            - query: '{"term": {"version": "2.19"}}'
              expected_hits: 1500
            - query: '{"term": {"minor_upgrade": "2.9_to_2.19"}}'
              expected_hits: 1500

  - name: "cluster_health_final"
    description: "Final cluster health and configuration validation"
    steps:
      - action: update_cluster_allocation_settings
        params:
          allocation_enable: "all"
      - action: validate_cluster_health
        params:
          expected_status: "green"
          timeout: "5m"
          check_nodes: true
          check_indices: true
      - action: validate_operator_status
        params:
          expected_phase: "Running"
          check_events: true
          max_restart_count: 0
      - action: validate_cluster_configuration
        params:
          total_nodes:
            expected: 3
          node_role_distribution:
            master:
              minimum: 3
              maximum: 3
            data:
              minimum: 3
              maximum: 3
